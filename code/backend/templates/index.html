<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>COINS Live P/L Dashboard</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { padding: 2rem; }
        .profit { color: green; font-weight: 600; }
        .loss { color: red; font-weight: 600; }
        .error-row { color: #b00020; font-style: italic; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-3">COINS Live P/L Dashboard</h1>

    <a class="btn btn-success mb-3" href="/add-trade">Add New Trade</a>

    <p class="text-muted">
        Unofficial dashboard for monitoring unrealized P/L on open COINS trades.
        Data updates automatically every 15 seconds.
        (Trades must be manually closed by an authorized person via terminal or secure script.)
    </p>

    <table class="table table-striped align-middle" id="pl-table">
        <thead>
        <tr>
            <th>Ticker</th>
            <th>Entry Price ($)</th>
            <th>Live Price ($)</th>
            <th>Shares</th>
            <th>Position Type</th>
            <th>Position Amount (%)</th>
            <th>Added On</th>
            <th>Unrealized P/L ($)</th>
            <th>Unrealized P/L (%)</th>
            <th>Delete</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <p class="text-muted small">
        Prices pulled from Yahoo Finance (yfinance). May be delayed ~15 minutes and are for
        educational/club use only.
    </p>
</div>

<script>
    function renderTable(rows) {
        const tbody = document.querySelector("#pl-table tbody");
        tbody.innerHTML = "";

        rows.forEach(row => {
            if (row.error) {
                tbody.innerHTML += `
                    <tr class="error-row">
                        <td>${row.ticker}</td>
                        <td colspan="9">Error: ${row.error}</td>
                    </tr>`;
                return;
            }

            const plClass = row.unrealized_pl >= 0 ? "profit" : "loss";

            const addedOn = row.open_date
                ? new Date(row.open_date).toLocaleString()
                : "â€”";

            tbody.innerHTML += `
                <tr>
                    <td>${row.ticker}</td>
                    <td>${row.entry_price.toFixed(2)}</td>
                    <td>${row.live_price.toFixed(2)}</td>
                    <td>${row.shares}</td>
                    <td>${row.position_type}</td>
                    <td>${row.position_amount}</td>
                    <td>${addedOn}</td>
                    <td class="${plClass}">${row.unrealized_pl.toFixed(2)}</td>
                    <td class="${plClass}">${row.unrealized_pl_pct.toFixed(2)}%</td>
                    <td>
                        <button class="btn btn-danger btn-sm"
                                onclick="deleteTrade('${row.ticker}')">
                            Delete
                        </button>
                    </td>
                </tr>`;
        });
    }

    function refreshPL() {
        fetch("/api/pl")
            .then(res => res.json())
            .then(renderTable)
            .catch(err => console.error("Error fetching P/L:", err));
    }

    function deleteTrade(ticker) {
        if (!confirm(`Delete trade ${ticker}?`)) return;

        fetch("/api/delete-trade", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker })
        })
        .then(res => res.json())
        .then(() => refreshPL())
        .catch(err => console.error("Delete error:", err));
    }

    refreshPL();
    setInterval(refreshPL, 15000);
</script>

</body>
</html>